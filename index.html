<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Smart Meter Dashboard</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                padding: 20px;
            }

            .container {
                max-width: 1400px;
                margin: 0 auto;
            }

            .header {
                background: white;
                padding: 25px;
                border-radius: 15px;
                margin-bottom: 20px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            }

            .header h1 {
                color: #667eea;
                font-size: 28px;
                margin-bottom: 10px;
            }

            .connection-status {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
            }

            .status-online {
                background: #d4edda;
                color: #155724;
            }

            .status-offline {
                background: #f8d7da;
                color: #721c24;
            }

            .status-dot {
                width: 10px;
                height: 10px;
                border-radius: 50%;
                animation: pulse 2s infinite;
            }

            .status-online .status-dot {
                background: #28a745;
            }

            .status-offline .status-dot {
                background: #dc3545;
            }

            @keyframes pulse {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 20px;
            }

            .card {
                background: white;
                padding: 25px;
                border-radius: 15px;
                box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            }

            .card h2 {
                color: #333;
                font-size: 18px;
                margin-bottom: 20px;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .consumption-display {
                text-align: center;
                padding: 20px;
            }

            .consumption-value {
                font-size: 48px;
                font-weight: bold;
                color: #667eea;
                margin: 10px 0;
            }

            .consumption-unit {
                font-size: 20px;
                color: #666;
            }

            .progress-bar {
                width: 100%;
                height: 30px;
                background: #e9ecef;
                border-radius: 15px;
                overflow: hidden;
                margin: 20px 0;
                position: relative;
            }

            .progress-fill {
                height: 100%;
                background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
                transition: width 0.5s ease;
                border-radius: 15px;
            }

            .progress-fill.warning {
                background: linear-gradient(90deg, #f39c12 0%, #e67e22 100%);
            }

            .progress-fill.danger {
                background: linear-gradient(90deg, #e74c3c 0%, #c0392b 100%);
            }

            .progress-text {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-weight: bold;
                color: #333;
                font-size: 14px;
            }

            .limit-display {
                text-align: center;
                color: #666;
                margin-top: 10px;
                font-size: 14px;
            }

            .relay-control {
                text-align: center;
                padding: 20px 0;
            }

            .toggle-container {
                position: relative;
                display: inline-block;
                margin: 20px 0;
            }

            .toggle-switch {
                position: relative;
                width: 80px;
                height: 40px;
                background: #ccc;
                border-radius: 40px;
                cursor: pointer;
                transition: background 0.3s;
            }

            .toggle-switch.on {
                background: #28a745;
            }

            .toggle-switch.disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .toggle-slider {
                position: absolute;
                top: 4px;
                left: 4px;
                width: 32px;
                height: 32px;
                background: white;
                border-radius: 50%;
                transition: left 0.3s;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            }

            .toggle-switch.on .toggle-slider {
                left: 44px;
            }

            .relay-status {
                font-size: 18px;
                font-weight: bold;
                margin: 15px 0;
                padding: 10px;
                border-radius: 8px;
            }

            .relay-status.on {
                color: #155724;
                background: #d4edda;
            }

            .relay-status.off {
                color: #721c24;
                background: #f8d7da;
            }

            .control-mode {
                display: flex;
                justify-content: center;
                gap: 10px;
                margin-top: 15px;
            }

            .mode-btn {
                padding: 8px 20px;
                border: 2px solid #667eea;
                background: white;
                color: #667eea;
                border-radius: 20px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
            }

            .mode-btn.active {
                background: #667eea;
                color: white;
            }

            .mode-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            }

            .limit-control {
                display: flex;
                align-items: center;
                gap: 10px;
                margin-top: 20px;
            }

            .limit-input {
                flex: 1;
                padding: 12px;
                border: 2px solid #e9ecef;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s;
            }

            .limit-input:focus {
                outline: none;
                border-color: #667eea;
            }

            .btn {
                padding: 12px 24px;
                background: #667eea;
                color: white;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
            }

            .btn:hover {
                background: #5568d3;
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            }

            .btn:disabled {
                background: #ccc;
                cursor: not-allowed;
                transform: none;
            }

            .realtime-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
            }

            .realtime-item {
                text-align: center;
                padding: 15px;
                background: #f8f9fa;
                border-radius: 10px;
                border-left: 4px solid #667eea;
            }

            .realtime-label {
                font-size: 12px;
                color: #666;
                margin-bottom: 5px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .realtime-value {
                font-size: 24px;
                font-weight: bold;
                color: #333;
            }

            .realtime-unit {
                font-size: 14px;
                color: #666;
            }

            .last-update {
                text-align: center;
                color: #666;
                font-size: 12px;
                margin-top: 15px;
                padding: 8px;
                background: #f8f9fa;
                border-radius: 6px;
            }

            .alert {
                padding: 15px;
                border-radius: 8px;
                margin-bottom: 20px;
                font-weight: 600;
                animation: slideIn 0.3s ease;
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(-10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .alert-danger {
                background: #f8d7da;
                color: #721c24;
                border-left: 4px solid #dc3545;
            }

            .alert-warning {
                background: #fff3cd;
                color: #856404;
                border-left: 4px solid #ffc107;
            }

            .alert-success {
                background: #d4edda;
                color: #155724;
                border-left: 4px solid #28a745;
            }

            .chart-controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
            }

            .chart-btn {
                padding: 10px 20px;
                background: white;
                border: 2px solid #667eea;
                color: #667eea;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
            }

            .chart-btn.active {
                background: #667eea;
                color: white;
            }

            .chart-container {
                background: white;
                padding: 20px;
                border-radius: 10px;
                height: 400px;
            }

            canvas {
                max-width: 100%;
            }

            .loading {
                text-align: center;
                padding: 40px;
                color: #666;
            }

            .spinner {
                border: 4px solid #f3f3f3;
                border-top: 4px solid #667eea;
                border-radius: 50%;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: 20px auto;
            }

            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }

            @media (max-width: 768px) {
                .header h1 {
                    font-size: 22px;
                }

                .consumption-value {
                    font-size: 36px;
                }

                .dashboard-grid {
                    grid-template-columns: 1fr;
                }

                .realtime-grid {
                    grid-template-columns: repeat(2, 1fr);
                }

                .chart-controls {
                    flex-direction: column;
                }

                .chart-btn {
                    width: 100%;
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>⚡ Smart Meter Dashboard</h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span id="statusText">Connecting...</span>
                </div>
            </div>

            <div id="alertContainer"></div>

            <div class="dashboard-grid">
                <!-- Daily Consumption Card -->
                <div class="card">
                    <h2>📊 Daily Consumption</h2>
                    <div class="consumption-display">
                        <div class="consumption-value" id="consumptionValue">
                            0.000
                        </div>
                        <div class="consumption-unit">kWh</div>

                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                            <div class="progress-text" id="progressText">
                                0%
                            </div>
                        </div>

                        <div class="limit-display">
                            Daily Limit:
                            <strong id="limitDisplay">10.5</strong> kWh
                        </div>
                    </div>

                    <div class="limit-control">
                        <input
                            type="number"
                            class="limit-input"
                            id="limitInput"
                            placeholder="Enter new limit (kWh)"
                            step="0.1"
                            min="0.1"
                        />
                        <button class="btn" id="updateLimitBtn">
                            Update Limit
                        </button>
                    </div>
                </div>

                <!-- Relay Control Card -->
                <div class="card">
                    <h2>🔌 Load Control</h2>
                    <div class="relay-control">
                        <div class="relay-status" id="relayStatus">
                            Status: OFF
                        </div>

                        <div class="toggle-container">
                            <div class="toggle-switch" id="toggleSwitch">
                                <div class="toggle-slider"></div>
                            </div>
                        </div>

                        <div class="control-mode">
                            <button class="mode-btn active" id="autoBtn">
                                Auto
                            </button>
                            <button class="mode-btn" id="manualBtn">
                                Manual
                            </button>
                        </div>

                        <div
                            style="
                                margin-top: 20px;
                                font-size: 14px;
                                color: #666;
                            "
                        >
                            <div>
                                Control Mode:
                                <strong id="modeDisplay">Auto</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Real-time Data Card -->
            <div class="card">
                <h2>⚡ Real-time Measurements</h2>
                <div class="realtime-grid">
                    <div class="realtime-item">
                        <div class="realtime-label">Voltage</div>
                        <div class="realtime-value" id="voltageValue">0.00</div>
                        <div class="realtime-unit">V</div>
                    </div>
                    <div class="realtime-item">
                        <div class="realtime-label">Current</div>
                        <div class="realtime-value" id="currentValue">
                            0.000
                        </div>
                        <div class="realtime-unit">A</div>
                    </div>
                    <div class="realtime-item">
                        <div class="realtime-label">Power</div>
                        <div class="realtime-value" id="powerValue">0.00</div>
                        <div class="realtime-unit">W</div>
                    </div>
                    <div class="realtime-item">
                        <div class="realtime-label">Frequency</div>
                        <div class="realtime-value" id="frequencyValue">
                            0.00
                        </div>
                        <div class="realtime-unit">Hz</div>
                    </div>
                    <div class="realtime-item">
                        <div class="realtime-label">Power Factor</div>
                        <div class="realtime-value" id="pfValue">0.000</div>
                        <div class="realtime-unit"></div>
                    </div>
                </div>
                <div class="last-update" id="lastUpdate">
                    Last updated: Never
                </div>
            </div>

            <!-- Chart Card -->
            <div class="card">
                <h2>📈 Energy Consumption History</h2>
                <div class="chart-controls">
                    <button class="chart-btn active" id="dailyBtn">
                        Last 7 Days
                    </button>
                    <button class="chart-btn" id="weeklyBtn">
                        Last 4 Weeks
                    </button>
                    <button class="chart-btn" id="monthlyBtn">Monthly</button>
                </div>
                <div class="chart-container">
                    <canvas id="consumptionChart"></canvas>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
        <script>
            const FIREBASE_URL =
                "https://smart-meter-942ce-default-rtdb.firebaseio.com/smartMeter";

            let currentData = {
                consumption: 0,
                limit: 10.5,
                loadStatus: "off",
                controlMode: "auto",
                relayCommand: "auto",
            };

            let isOnline = false;
            let chart = null;
            let chartType = "daily";

            // Initialize
            document.addEventListener("DOMContentLoaded", () => {
                initializeEventListeners();
                startDataPolling();
                initializeChart();
            });

            function initializeEventListeners() {
                document
                    .getElementById("toggleSwitch")
                    .addEventListener("click", handleToggleClick);
                document
                    .getElementById("autoBtn")
                    .addEventListener("click", () => setControlMode("auto"));
                document
                    .getElementById("manualBtn")
                    .addEventListener("click", () => setControlMode("manual"));
                document
                    .getElementById("updateLimitBtn")
                    .addEventListener("click", updateDailyLimit);
                document
                    .getElementById("dailyBtn")
                    .addEventListener("click", () => changeChartView("daily"));
                document
                    .getElementById("weeklyBtn")
                    .addEventListener("click", () => changeChartView("weekly"));
                document
                    .getElementById("monthlyBtn")
                    .addEventListener("click", () =>
                        changeChartView("monthly")
                    );
            }

            function startDataPolling() {
                fetchAllData();
                setInterval(fetchAllData, 3000); // Poll every 3 seconds
            }

            async function fetchAllData() {
                try {
                    const [currentDay, settings, realtime] = await Promise.all([
                        fetch(`${FIREBASE_URL}/currentDay.json`).then((r) =>
                            r.json()
                        ),
                        fetch(`${FIREBASE_URL}/settings.json`).then((r) =>
                            r.json()
                        ),
                        fetch(`${FIREBASE_URL}/realtime.json`).then((r) =>
                            r.json()
                        ),
                    ]);

                    isOnline = true;
                    updateConnectionStatus(true);

                    if (currentDay) {
                        currentData.consumption = currentDay.consumption || 0;
                        currentData.loadStatus = currentDay.loadStatus || "off";
                        currentData.controlMode =
                            currentDay.controlMode || "auto";
                        updateConsumptionDisplay();
                        updateRelayStatus();
                    }

                    if (settings) {
                        currentData.limit = settings.dailyLimit || 10.5;
                        currentData.relayCommand =
                            settings.relayCommand || "auto";
                        updateLimitDisplay();
                    }

                    if (realtime) {
                        updateRealtimeData(realtime);
                    }
                } catch (error) {
                    console.error("Error fetching data:", error);
                    isOnline = false;
                    updateConnectionStatus(false);
                }
            }

            function updateConnectionStatus(online) {
                const statusEl = document.getElementById("connectionStatus");
                const statusText = document.getElementById("statusText");

                if (online) {
                    statusEl.className = "connection-status status-online";
                    statusText.textContent = "Connected";
                } else {
                    statusEl.className = "connection-status status-offline";
                    statusText.textContent = "Connection Lost";
                }
            }

            function updateConsumptionDisplay() {
                const consumption = currentData.consumption;
                const limit = currentData.limit;
                const percentage = Math.min((consumption / limit) * 100, 100);

                document.getElementById("consumptionValue").textContent =
                    consumption.toFixed(3);
                document.getElementById("progressText").textContent =
                    percentage.toFixed(1) + "%";

                const progressFill = document.getElementById("progressFill");
                progressFill.style.width = percentage + "%";

                progressFill.className = "progress-fill";
                if (percentage >= 100) {
                    progressFill.classList.add("danger");
                } else if (percentage >= 80) {
                    progressFill.classList.add("warning");
                }

                // Check if limit reached
                if (
                    consumption >= limit &&
                    currentData.controlMode === "auto"
                ) {
                    showAlert(
                        "danger",
                        "⚠️ Daily limit reached! Load has been turned off automatically."
                    );
                }
            }

            function updateLimitDisplay() {
                document.getElementById("limitDisplay").textContent =
                    currentData.limit.toFixed(1);
            }

            function updateRelayStatus() {
                const status = currentData.loadStatus === "on";
                const statusEl = document.getElementById("relayStatus");
                const toggleSwitch = document.getElementById("toggleSwitch");

                if (status) {
                    statusEl.textContent = "Status: ON";
                    statusEl.className = "relay-status on";
                    toggleSwitch.classList.add("on");
                } else {
                    statusEl.textContent = "Status: OFF";
                    statusEl.className = "relay-status off";
                    toggleSwitch.classList.remove("on");
                }

                // Update control mode display
                document.getElementById("modeDisplay").textContent =
                    currentData.controlMode.charAt(0).toUpperCase() +
                    currentData.controlMode.slice(1);

                // Update mode buttons
                if (currentData.controlMode === "auto") {
                    document.getElementById("autoBtn").classList.add("active");
                    document
                        .getElementById("manualBtn")
                        .classList.remove("active");
                } else {
                    document
                        .getElementById("manualBtn")
                        .classList.add("active");
                    document
                        .getElementById("autoBtn")
                        .classList.remove("active");
                }
            }

            function updateRealtimeData(data) {
                document.getElementById("voltageValue").textContent = (
                    data.voltage || 0
                ).toFixed(2);
                document.getElementById("currentValue").textContent = (
                    data.current || 0
                ).toFixed(3);
                document.getElementById("powerValue").textContent = (
                    data.power || 0
                ).toFixed(2);
                document.getElementById("frequencyValue").textContent = (
                    data.frequency || 0
                ).toFixed(2);
                document.getElementById("pfValue").textContent = (
                    data.powerFactor || 0
                ).toFixed(3);

                if (data.timestamp) {
                    document.getElementById("lastUpdate").textContent =
                        "Last updated: " + data.timestamp;
                }

                if (data.status === "error" && data.errorMessage) {
                    console.warn("Sensor error:", data.errorMessage);
                }
            }

            async function handleToggleClick() {
                if (!isOnline) {
                    showAlert(
                        "danger",
                        "❌ Cannot control relay - No internet connection"
                    );
                    return;
                }

                const isLimitReached =
                    currentData.consumption >= currentData.limit;
                const currentStatus = currentData.loadStatus === "on";

                // If trying to turn ON when limit is reached
                if (!currentStatus && isLimitReached) {
                    showAlert(
                        "danger",
                        "❌ Cannot turn ON - Daily limit reached! Please increase the limit first."
                    );
                    return;
                }

                // If in auto mode, switch to manual
                if (currentData.controlMode === "auto") {
                    await setControlMode("manual");
                }

                const newCommand = currentStatus ? "off" : "on";
                await updateFirebase("settings", { relayCommand: newCommand });

                showAlert(
                    "success",
                    `✅ Relay turned ${newCommand.toUpperCase()} successfully`
                );
            }

            async function setControlMode(mode) {
                if (!isOnline) {
                    showAlert(
                        "danger",
                        "❌ Cannot change mode - No internet connection"
                    );
                    return;
                }

                const command =
                    mode === "auto" ? "auto" : currentData.loadStatus;
                await updateFirebase("settings", { relayCommand: command });

                showAlert(
                    "success",
                    `✅ Switched to ${mode.toUpperCase()} mode`
                );
            }

            async function updateDailyLimit() {
                if (!isOnline) {
                    showAlert(
                        "danger",
                        "❌ Cannot update limit - No internet connection"
                    );
                    return;
                }

                const input = document.getElementById("limitInput");
                const newLimit = parseFloat(input.value);

                if (isNaN(newLimit) || newLimit <= 0) {
                    showAlert(
                        "warning",
                        "⚠️ Please enter a valid limit (greater than 0)"
                    );
                    return;
                }

                await updateFirebase("settings", { dailyLimit: newLimit });

                input.value = "";
                showAlert(
                    "success",
                    `✅ Daily limit updated to ${newLimit.toFixed(1)} kWh`
                );
            }

            async function updateFirebase(path, data) {
                try {
                    const response = await fetch(
                        `${FIREBASE_URL}/${path}.json`,
                        {
                            method: "PATCH",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify(data),
                        }
                    );

                    if (!response.ok) throw new Error("Update failed");

                    // Immediately fetch updated data
                    setTimeout(fetchAllData, 500);
                } catch (error) {
                    console.error("Error updating Firebase:", error);
                    showAlert(
                        "danger",
                        "❌ Update failed - Please check your connection"
                    );
                }
            }

            function showAlert(type, message) {
                const container = document.getElementById("alertContainer");
                const alert = document.createElement("div");
                alert.className = `alert alert-${type}`;
                alert.textContent = message;

                container.innerHTML = "";
                container.appendChild(alert);

                setTimeout(() => {
                    alert.style.opacity = "0";
                    setTimeout(() => alert.remove(), 300);
                }, 5000);
            }

            // Chart functions
            function initializeChart() {
                const ctx = document
                    .getElementById("consumptionChart")
                    .getContext("2d");
                chart = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: [],
                        datasets: [
                            {
                                label: "Energy Consumption (kWh)",
                                data: [],
                                backgroundColor: "rgba(102, 126, 234, 0.8)",
                                borderColor: "rgba(102, 126, 234, 1)",
                                borderWidth: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: "Energy (kWh)",
                                },
                            },
                        },
                    },
                });

                loadChartData("daily");
            }

            function changeChartView(type) {
                chartType = type;

                document
                    .querySelectorAll(".chart-btn")
                    .forEach((btn) => btn.classList.remove("active"));
                document.getElementById(`${type}Btn`).classList.add("active");

                loadChartData(type);
            }

            async function loadChartData(type) {
                try {
                    const history = await fetch(
                        `${FIREBASE_URL}/history.json`
                    ).then((r) => r.json());

                    if (!history) {
                        chart.data.labels = ["No data"];
                        chart.data.datasets[0].data = [0];
                        chart.update();
                        return;
                    }

                    let labels = [];
                    let data = [];

                    if (type === "daily") {
                        // Last 7 days
                        const dates = getAllDatesFromHistory(history);
                        const last7 = dates.slice(-7);

                        labels = last7.map((date) => {
                            const d = new Date(date);
                            return d.toLocaleDateString("en-US", {
                                month: "short",
                                day: "numeric",
                            });
                        });

                        data = last7.map((date) => {
                            const [year, month] = date.split("-").slice(0, 2);
                            const yearMonth = `${year}-${month}`;
                            return (
                                history[yearMonth]?.[date]?.totalConsumption ||
                                0
                            );
                        });
                    } else if (type === "weekly") {
                        // Last 4 weeks (7-day aggregates)
                        const dates = getAllDatesFromHistory(history);
                        const weeks = [];

                        for (let i = 0; i < 4; i++) {
                            const weekDates = dates.slice(
                                -(7 * (i + 1)),
                                dates.length - 7 * i || undefined
                            );
                            if (weekDates.length > 0) {
                                const weekTotal = weekDates.reduce(
                                    (sum, date) => {
                                        const [year, month] = date
                                            .split("-")
                                            .slice(0, 2);
                                        const yearMonth = `${year}-${month}`;
                                        return (
                                            sum +
                                            (history[yearMonth]?.[date]
                                                ?.totalConsumption || 0)
                                        );
                                    },
                                    0
                                );
                                weeks.unshift({
                                    label: `Week ${4 - i}`,
                                    total: weekTotal,
                                });
                            }
                        }

                        labels = weeks.map((w) => w.label);
                        data = weeks.map((w) => w.total);
                    } else if (type === "monthly") {
                        // Last 6 months
                        const months = Object.keys(history).sort().slice(-6);

                        labels = months.map((ym) => {
                            const [year, month] = ym.split("-");
                            const date = new Date(year, parseInt(month) - 1);
                            return date.toLocaleDateString("en-US", {
                                month: "short",
                                year: "numeric",
                            });
                        });

                        data = months.map((ym) => {
                            const monthData = history[ym];
                            return Object.values(monthData).reduce(
                                (sum, day) => sum + (day.totalConsumption || 0),
                                0
                            );
                        });
                    }

                    chart.data.labels =
                        labels.length > 0 ? labels : ["No data"];
                    chart.data.datasets[0].data = data.length > 0 ? data : [0];
                    chart.update();
                } catch (error) {
                    console.error("Error loading chart data:", error);
                }
            }

            function getAllDatesFromHistory(history) {
                const dates = [];
                Object.keys(history).forEach((yearMonth) => {
                    Object.keys(history[yearMonth]).forEach((date) => {
                        dates.push(date);
                    });
                });
                return dates.sort();
            }
        </script>
    </body>
</html>
